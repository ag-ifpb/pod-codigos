package ag.protocol.impl;

import java.util.Arrays;

import ag.protocol.Frame;
import ag.protocol.FrameUnmarshaller;
import ag.protocol.util.Util;

public class FrameUnmarshallerImpl implements FrameUnmarshaller {

	@Override
	public Frame unmarshal(byte[] f) {
		//resultado
		Frame frame = new Frame();
		//extrair apenas os dois primeiros bits no byte
		byte first = (byte) (f[0] & 0xC0);
		byte two = f[1];
		//verificar se é requisição
		byte isReq = (byte) (first & 0x80);
		if (isReq == 0x80){
			frame.setTypeAsResponse();
		} else {
			frame.setTypeAsRequest();
		}
		//verificar se é tipo texto
		byte isText = (byte) (first & 0x40);
		if (isText == 0x00){
			frame.setPayloadAsBinary();
		} else {
			frame.setPayloadAsText();
		}
		//capturando o tamanho
		int newfirst = (first & 0x3F) << 10;
		long newtwo   = two  << 2;
		long lenght = (newfirst |  newtwo) >> 6;
		System.out.println(lenght);
		//capturando o conteúdo
		byte[] content = Arrays.copyOfRange(f, 2, (int)(2+lenght));
		frame.setPayload(content);
		//
		return frame;
	}

}
